ifndef::imagesdir[:imagesdir: ../images]

[[section-runtime-view]]
== Laufzeitsicht

=== Überblick

Dieses Kapitel beschreibt die wichtigsten Ablaufszenarien des Systems zur Laufzeit. Es zeigt, wie die in Kapitel 5 beschriebenen Bausteine zusammenarbeiten, um die Hauptfunktionalitäten zu realisieren.

**Abgedeckte Szenarien:**

1. Puzzle-Generierung (Generator)
2. Puzzle-Lösung (Solver)

=== Szenario 1: Puzzle-Generierung

==== Motivation

Ein Entwickler möchte ein neues Test-Puzzle mit realistischen Kamera-Effekten generieren, um den Solver zu testen.

==== Ablauf

[source]
----
User                Flask           api.py          geometry/       rendering/      simulation/
 │                   │               │               puzzle.py       renderer.py     camera.py
 │                   │               │               │               │               │
 │ POST /generate    │               │               │               │               │
 ├──────────────────>│               │               │               │               │
 │ {seed: 42,        │               │               │               │               │
 │  cut_types: [...],│               │               │               │               │
 │  layout: "2x3"}   │               │               │               │               │
 │                   │               │               │               │               │
 │                   │ parse params  │               │               │               │
 │                   ├──────────────>│               │               │               │
 │                   │               │               │               │               │
 │                   │               │ generate()    │               │               │
 │                   │               ├──────────────>│               │               │
 │                   │               │               │               │               │
 │                   │               │               │ _assign_edge_cuts()           │
 │                   │               │               │ (Male/Female Pairing)         │
 │                   │               │               ├──────────┐    │               │
 │                   │               │               │          │    │               │
 │                   │               │               │<─────────┘    │               │
 │                   │               │               │               │               │
 │                   │               │               │ _create_piece() (6x)          │
 │                   │               │               ├──────────┐    │               │
 │                   │               │               │          │    │               │
 │                   │               │               │<─────────┘    │               │
 │                   │               │               │               │               │
 │                   │               │               │ _randomize_placement()        │
 │                   │               │               │ (Grid + Rotation)             │
 │                   │               │               ├──────────┐    │               │
 │                   │               │               │          │    │               │
 │                   │               │               │<─────────┘    │               │
 │                   │               │               │               │               │
 │                   │               │ pieces        │               │               │
 │                   │               │<──────────────┤               │               │
 │                   │               │               │               │               │
 │                   │               │ render_clean()│               │               │
 │                   │               ├───────────────┼──────────────>│               │
 │                   │               │               │               │               │
 │                   │               │               │               │ _render_shadow()
 │                   │               │               │               ├──────────┐
 │                   │               │               │               │          │
 │                   │               │               │               │<─────────┘
 │                   │               │               │               │
 │                   │               │               │               │ _render_pieces()
 │                   │               │               │               ├──────────┐
 │                   │               │               │               │          │
 │                   │               │               │               │<─────────┘
 │                   │               │               │               │
 │                   │               │ clean_image   │               │
 │                   │               │<──────────────┼───────────────┤
 │                   │               │               │               │
 │                   │               │ render_solution()             │
 │                   │               ├───────────────┼──────────────>│
 │                   │               │               │               │
 │                   │               │ solution_img  │               │
 │                   │               │<──────────────┼───────────────┤
 │                   │               │               │               │
 │                   │               │ apply_camera_sim()            │
 │                   │               ├───────────────┼───────────────┼──────────────>│
 │                   │               │               │               │               │
 │                   │               │               │               │        barrel_distortion()
 │                   │               │               │               │        perspective()
 │                   │               │               │               │        chromatic_aberration()
 │                   │               │               │               │               │
 │                   │               │ noisy_image   │               │               │
 │                   │               │<──────────────┼───────────────┼───────────────┤
 │                   │               │               │               │               │
 │                   │ result        │               │               │               │
 │                   │<──────────────┤               │               │               │
 │                   │               │               │               │               │
 │ JSON response     │               │               │               │               │
 │<──────────────────┤               │               │               │               │
 │ {noisy_image,     │               │               │               │               │
 │  solution_image,  │               │               │               │               │
 │  metadata}        │               │               │               │               │
----

==== Wichtige Schritte

* 1. Edge Cuts zuteilen

* 2. Teile generieren

* 3. Zufälliges platzieren

* 4. Sauberes Rendering

* 5. Rendering der Lösung

* 6. Kamera Simulation


=== Szenario 2: Puzzle-Lösung

==== Motivation

Ein Entwickler lädt ein vom Generator erzeugtes Puzzle-Bild hoch und möchte die automatische Lösung testen.

==== Ablauf

[source]
----
User          Flask        preprocessing/  piece_extraction/  edge_detection/  edge_matching/  solver/
 │            routes.py    global_cleaner  extractor.py       edge_detector    edge_matcher    solver.py
 │             │           │               │                  │                │               │
 │ POST /upload│           │               │                  │                │               │
 ├────────────>│           │               │                  │                │               │
 │             │ save img  │               │                  │                │               │
 │             │           │               │                  │                │               │
 │ GET /extract│           │               │                  │                │               │
 ├────────────>│           │               │                  │                │               │
 │             │           │               │                  │                │               │
 │             │           │               │                  │                │               │
 │             │ clean()   │               │                  │                │               │
 │             ├──────────>│               │                  │                │               │
 │             │           │ undistort()   │                  │                │               │
 │             │           ├──────┐        │                  │                │               │
 │             │           │      │        │                  │                │               │
 │             │           │<─────┘        │                  │                │               │
 │             │           │               │                  │                │               │
 │             │ cleaned   │               │                  │                │               │
 │             │<──────────┤               │                  │                │               │
 │             │           │               │                  │                │               │
 │             │ segment_pieces()          │                  │                │               │
 │             ├───────────┼──────────────>│                  │                │               │
 │             │           │               │ findContours()   │                │               │
 │             │           │               ├──────────┐       │                │               │
 │             │           │               │          │       │                │               │
 │             │           │               │<─────────┘       │                │               │
 │             │           │               │                  │                │               │
 │             │ pieces    │               │                  │                │               │
 │             │<──────────┼───────────────┤                  │                │               │
 │             │           │               │                  │                │               │
 │             │           │               │                  │                │               │
 │ JSON resp.  │           │               │                  │                │               │
 │<────────────┤           │               │                  │                │               │
 │             │           │               │                  │                │               │
 │ GET /detect-edges       │               │                  │                │               │
 ├────────────>│           │               │                  │                │               │
 │             │           │               │                  │                │               │
 │             │ detect_edges()            │                  │                │               │
 │             ├───────────┼───────────────┼─────────────────>│                │               │
 │             │           │               │                  │ snap corners   │               │
 │             │           │               │                  │ extract edges  │               │
 │             │           │               │                  │ classify       │               │
 │             │           │               │                  │ (flat/tab/slot)│               │
 │             │           │               │                  ├──────────┐     │               │
 │             │           │               │                  │          │     │               │
 │             │           │               │                  │<─────────┘     │               │
 │             │           │               │                  │                │               │
 │             │ edges     │               │                  │                │               │
 │             │<──────────┼───────────────┼──────────────────┤                │               │
 │             │           │               │                  │                │               │
 │ JSON resp.  │           │               │                  │                │               │
 │<────────────┤           │               │                  │                │               │
 │             │           │               │                  │                │               │
 │ GET /solve-puzzle       │               │                  │                │               │
 ├────────────>│           │               │                  │                │               │
 │             │           │               │                  │                │               │
 │             │           │               │                  │                │               │
 │             │ find_matches()            │                  │                │               │
 │             ├───────────┼───────────────┼──────────────────┼───────────────>│               │
 │             │           │               │                  │                │ correlation   │
 │             │           │               │                  │                │ class compatibility
 │             │           │               │                  │                │ find unique matches
 │             │           │               │                  │                ├──────────┐    │
 │             │           │               │                  │                │          │    │
 │             │           │               │                  │                │<─────────┘    │
 │             │           │               │                  │                │               │
 │             │ matches   │               │                  │                │               │
 │             │<──────────┼───────────────┼──────────────────┼────────────────┤               │
 │             │           │               │                  │                │               │
 │             │ solve()   │               │                  │                │               │
 │             ├───────────┼───────────────┼──────────────────┼────────────────┼──────────────>│
 │             │           │               │                  │                │               │
 │             │           │               │                  │                │ identify_corners()
 │             │           │               │                  │                │ (piece with 2 flat edges)
 │             │           │               │                  │                │               │
 │             │           │               │                  │                │ try_each_corner()
 │             │           │               │                  │                │ as top-left
 │             │           │               │                  │                │               │
 │             │           │               │                  │                │ greedy_expand()
 │             │           │               │                  │                │ via matches   │
 │             │           │               │                  │                │               │
 │             │           │               │                  │                │ calculate_rotations()
 │             │           │               │                  │                ├──────────┐    │
 │             │           │               │                  │                │          │    │
 │             │           │               │                  │                │<─────────┘    │
 │             │           │               │                  │                │               │
 │             │ solution  │               │                  │                │               │
 │             │<──────────┼───────────────┼──────────────────┼────────────────┼───────────────┤
 │             │           │               │                  │                │               │
 │ JSON resp.  │           │               │                  │                │               │
 │<────────────┤           │               │                  │                │               │
 │ { grid_layout,          │               │                  │                │               │
 │  placed_pieces,         │               │                  │                │               │
 │  confidence score }     │               │                  │                │               │
----

==== Wichtige Schritte

* 1. Global Cleaning
* 2. Segmentierung
* 3. Kantenerkennung
* 4. Kanten-Matching
* 5. Puzzle lösen

