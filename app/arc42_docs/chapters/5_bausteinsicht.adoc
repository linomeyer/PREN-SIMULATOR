
ifndef::imagesdir[:imagesdir: ../images]

[[section-building-block-view]]
== Bausteinsicht

=== Gesamtsystem (Ebene 1)

==== Übersichtsdiagramm

[plantuml, format=svg]
....
@startuml
!define RECTANGLE class

package "PREN Puzzle Simulator" {

  [Flask Application] as Flask

  package "Puzzle Generator Subsystem" {
    [Generator API] as GenAPI
    [Geometry Engine] as Geometry
    [Rendering Engine] as Rendering
    [Camera Simulation] as Camera
    [Calibration] as Calib
  }

  package "Puzzle Solver Subsystem" {
    [Solver API] as SolverAPI
    [Preprocessing] as Preproc
    [Segmentation] as Segment
    [Edge Detection] as EdgeDet
    [Edge Matching] as EdgeMatch
    [Solver Algorithm] as SolverAlgo
  }

  package "Shared Infrastructure" {
    [Configuration] as Config
    [Performance Tracking] as Perf
    [Visualization] as Visual
    [File Storage] as Storage
  }

  Flask --> GenAPI
  Flask --> SolverAPI

  GenAPI --> Geometry
  GenAPI --> Rendering
  GenAPI --> Camera
  GenAPI --> Calib

  SolverAPI --> Preproc
  SolverAPI --> Segment
  SolverAPI --> EdgeDet
  SolverAPI --> EdgeMatch
  SolverAPI --> SolverAlgo

  GenAPI ..> Config
  SolverAPI ..> Config
  GenAPI ..> Perf
  SolverAPI ..> Perf
  SolverAPI ..> Visual
  SolverAPI ..> Storage
  GenAPI ..> Storage
}

@enduml
....

==== Enthaltene Bausteine

[cols="1,3" options="header"]
|===
| Baustein | Verantwortlichkeit

| **Flask Application**
| REST-API Server; Routing; Request/Response Handling; Session Management

| **Puzzle Generator Subsystem**
| Erzeugt realistische Puzzle-Bilder mit Kamera-Simulation

| **Puzzle Solver Subsystem**
| Analysiert Puzzle-Bilder und rekonstruiert die Lösung

| **Shared Infrastructure**
| Gemeinsame Utilities für Konfiguration, Performance, Visualisierung
|===

==== Wichtige Schnittstellen

[cols="1,2,2" options="header"]
|===
| Schnittstelle | Protokoll | Beschreibung

| **REST-API**
| HTTP/JSON
| `/generate`, `/solve-puzzle/<filename>`, `/calibrate`

| **File System**
| Local FS
| `app/static/output/` für Visualisierungen, `app/main/img/` für Uploads

| **Configuration**
| Python Dataclasses
| Typsichere Parameter-Objekte (GeneratorConfig, PuzzleConfig, etc.)
|===

=== Puzzle Generator (Ebene 2)

==== Übersichtsdiagramm

```
┌─────────────────────────────────────────────────────────────────┐
│                    Puzzle Generator Subsystem                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴──────────┐
                    ▼                    ▼
         ┌──────────────────┐   ┌──────────────────┐
         │  routes.py       │   │  api.py          │
         │                  │   │                  │
         │  POST /generate  │──▶│  generate_      │
         │  POST /calibrate │   │  puzzle_images() │
         │  GET  /health    │   │                  │
         └──────────────────┘   └──────────────────┘
                                        │
              ┌─────────────────────────┼─────────────────────┐
              ▼                         ▼                     ▼
    ┌─────────────────┐      ┌─────────────────┐   ┌─────────────────┐
    │  geometry/      │      │  rendering/     │   │  simulation/    │
    ├─────────────────┤      ├─────────────────┤   ├─────────────────┤
    │                 │      │                 │   │                 │
    │  puzzle.py      │      │  renderer.py    │   │  camera.py      │
    │  • Generator    │─────▶│  • Renderer     │◀──│  • Simulator    │
    │  • PuzzlePiece  │      │  • Shadow       │   │                 │
    │  • PieceEdge    │      │  • Watermark    │   │  effects/       │
    │                 │      │                 │   │  • 11 Effects   │
    │  cuts.py        │      │                 │   │                 │
    │  • Cut (ABC)    │      │                 │   │                 │
    │  • 13 Impls     │      │                 │   │                 │
    └─────────────────┘      └─────────────────┘   └─────────────────┘
              │                                              │
              ▼                                              ▼
    ┌─────────────────┐                           ┌─────────────────┐
    │  config.py      │                           │  calibration/   │
    ├─────────────────┤                           ├─────────────────┤
    │                 │                           │                 │
    │  • Generator    │                           │  grid_          │
    │    Config       │                           │  calibrator.py  │
    │  • Puzzle       │                           │                 │
    │    Config       │                           │  • Hough Lines  │
    │  • Render       │                           │  • SciPy        │
    │    Config       │                           │    Optimize     │
    │  • Camera       │                           │                 │
    │    Config       │                           │                 │
    │  • Output       │                           │                 │
    │    Config       │                           │                 │
    └─────────────────┘                           └─────────────────┘
```

==== Enthaltene Bausteine

[cols="1,3,1" options="header"]
|===
| Baustein | Verantwortlichkeit | Technologie

| **routes.py**
| Flask-Routen, Request Parsing, Response Serialization
| Flask Blueprints

| **api.py**
| Business Logic, Orchestrierung der Pipeline
| Pure Python

| **geometry/**
| Parametrische Puzzle-Generierung, Cut-Algorithmen
| NumPy

| **rendering/**
| Bild-Rendering, Schatten, Wasserzeichen
| Pillow (PIL)

| **simulation/**
| Kamera-Effekt-Pipeline (11 Effects)
| OpenCV, NumPy

| **calibration/**
| Barrel Distortion Kalibrierung
| OpenCV, SciPy

| **config.py**
| Typsichere Konfiguration
| Python Dataclasses
|===

=== Whitebox Puzzle Solver (Ebene 2)

==== Übersichtsdiagramm

```
┌─────────────────────────────────────────────────────────────────┐
│                    Puzzle Solver Subsystem                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴──────────┐
                    ▼                    ▼
         ┌──────────────────┐   ┌──────────────────────┐
         │  routes.py       │   │  (Inline in routes)  │
         │                  │   │                      │
         │  POST /upload    │   │  Pipeline Logic:     │
         │  GET  /extract   │   │  • Cache segmenters  │
         │  GET  /detect-   │   │  • Cache cleaners    │
         │       edges      │   │  • Orchestrate steps │
         │  GET  /solve-    │   │                      │
         │       puzzle     │   │                      │
         └──────────────────┘   └──────────────────────┘
                                        │
       ┌────────────────────────────────┼─────────────────────────┐
       ▼                                ▼                         ▼
┌──────────────┐              ┌──────────────────┐     ┌──────────────────┐
│preprocessing/│              │piece_extraction/ │     │edge_detection/   │
├──────────────┤              ├──────────────────┤     ├──────────────────┤
│              │              │                  │     │                  │
│global_       │              │extractor.py      │     │edge_detector.py  │
│cleaner.py    │──────────────▶│• PieceSegmenter │────▶│• EdgeDetector    │
│              │              │• PuzzlePiece     │     │• PieceEdge       │
│• Barrel      │              │                  │     │                  │
│  Distortion  │              │extractor_        │     │edge_detector_    │
│• Perspective │              │visualizer.py     │     │visualizer.py     │
│• Vignette    │              │• PieceVisualizer │     │• EdgeVisualizer  │
│• Chromatic   │              │                  │     │                  │
│  Aberration  │              │                  │     │                  │
│              │              │                  │     │                  │
│image_        │              │                  │     │                  │
│cleaner.py    │              │                  │     │                  │
│• Morphology  │              │                  │     │                  │
└──────────────┘              └──────────────────┘     └──────────────────┘
                                                                 │
                              ┌──────────────────────────────────┤
                              ▼                                  ▼
                    ┌──────────────────┐              ┌──────────────────┐
                    │edge_matching/    │              │solver/           │
                    ├──────────────────┤              ├──────────────────┤
                    │                  │              │                  │
                    │edge_matcher.py   │──────────────▶│solver.py         │
                    │• EdgeMatcher     │              │• PuzzleSolver    │
                    │• EdgeMatch       │              │• PuzzleSolution  │
                    │                  │              │• PlacedPiece     │
                    │edge_matcher_     │              │                  │
                    │visualizer.py     │              │solver_           │
                    │• MatchVisualizer │              │visualizer.py     │
                    │                  │              │• Solution        │
                    │                  │              │  Visualizer      │
                    └──────────────────┘              └──────────────────┘
```

==== Enthaltene Bausteine

[cols="1,3,1" options="header"]
|===
| Baustein | Verantwortlichkeit | Technologie

| **preprocessing/**
| Globale (Kamera) und lokale (Kontur) Korrekturen
| OpenCV

| **piece_extraction/**
| Segmentierung, Otsu Thresholding, Morphologie
| OpenCV

| **edge_detection/**
| Eck-Erkennung, Kanten-Extraktion, PCA, Klassifikation
| OpenCV, NumPy

| **edge_matching/**
| Curvature-Korrelation, Length/Class Compatibility
| NumPy (Correlation)

| **solver/**
| Graph-basiertes Solving, Corner-Start, Greedy Expansion
| Pure Python

| **Visualizers**
| PNG-Outputs für alle Pipeline-Stufen
| OpenCV, Pillow
|===