
ifndef::imagesdir[:imagesdir: ../images]

[[section-building-block-view]]
== Bausteinsicht

=== Gesamtsystem (Ebene 1)

==== Übersichtsdiagramm

[plantuml, format=svg]
....
@startuml
!define RECTANGLE class

package "PREN Puzzle Simulator" {

  [Flask Application] as Flask

  package "Puzzle Generator Subsystem" {
    [Generator API] as GenAPI
    [Geometry Engine] as Geometry
    [Rendering Engine] as Rendering
    [Camera Simulation] as Camera
    [Calibration] as Calib
  }

  package "Puzzle Solver Subsystem" {
    [Solver API] as SolverAPI
    [Preprocessing] as Preproc
    [Segmentation] as Segment
    [Edge Detection] as EdgeDet
    [Edge Matching] as EdgeMatch
    [Solver Algorithm] as SolverAlgo
  }


  Flask --> GenAPI
  Flask --> SolverAPI

  GenAPI --> Geometry
  GenAPI --> Rendering
  GenAPI --> Camera
  GenAPI --> Calib

  SolverAPI --> Preproc
  SolverAPI --> Segment
  SolverAPI --> EdgeDet
  SolverAPI --> EdgeMatch
  SolverAPI --> SolverAlgo

}

@enduml
....

==== Enthaltene Bausteine

[cols="1,3" options="header"]
|===
| Baustein | Verantwortlichkeit

| **Flask Application**
| REST-API Server; Routing; Request/Response Handling; Session Management

| **Puzzle Generator Subsystem**
| Erzeugt realistische Puzzle-Bilder mit Kamera-Simulation

| **Puzzle Solver Subsystem**
| Analysiert Puzzle-Bilder und rekonstruiert die Lösung

|===

==== Wichtige Schnittstellen

[cols="1,2,2" options="header"]
|===
| Schnittstelle | Protokoll | Beschreibung

| **REST-API**
| HTTP/JSON
| `/generate`, `/solve-puzzle/<filename>`, `/calibrate`

| **File System**
| Local FS
| `app/static/output/` für Visualisierungen, `app/main/img/` für Uploads

| **Configuration**
| Python Dataclasses
| Typsichere Parameter-Objekte (GeneratorConfig, PuzzleConfig, etc.)
|===

=== Puzzle Generator (Ebene 2)

==== Übersichtsdiagramm

[source]
----
┌─────────────────────────────────────────────────────────────────┐
│                    Puzzle Generator Subsystem                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴──────────┐
                    ▼                    ▼
         ┌──────────────────┐   ┌──────────────────┐
         │  routes.py       │   │  api.py          │
         │                  │   │                  │
         │  POST /generate  │──▶│  generate_       │
         │  POST /calibrate │   │  puzzle_images() │
         │  GET  /health    │   │                  │
         └──────────────────┘   └──────────────────┘
                                        │
              ┌─────────────────────────┼─────────────────────┐
              ▼                         ▼                     ▼
    ┌─────────────────┐      ┌─────────────────┐   ┌─────────────────┐
    │  geometry/      │      │  rendering/     │   │  simulation/    │
    ├─────────────────┤      ├─────────────────┤   ├─────────────────┤
    │                 │      │                 │   │                 │
    │  puzzle.py      │      │  renderer.py    │   │  camera.py      │
    │  • Generator    │─────▶│  • Renderer     │◀──│                 │
    │  • PuzzlePiece  │      │  • Shadow       │   │                 │
    │  • PieceEdge    │      │                 │   │  effects/       │
    │                 │      │                 │   │  • 11 Types     │
    │  cuts.py        │      │                 │   │                 │
    │  • Cut (ABC)    │      │                 │   │                 │
    │  • 13 Impls     │      │                 │   │                 │
    └─────────────────┘      └─────────────────┘   └─────────────────┘
              │                                              │
              ▼                                              ▼
    ┌─────────────────┐                           ┌─────────────────┐
    │  config.py      │                           │  calibration/   │
    ├─────────────────┤                           ├─────────────────┤
    │                 │                           │                 │
    │  • Generator    │                           │  grid_          │
    │    Config       │                           │  calibrator.py  │
    │  • Puzzle       │                           │                 │
    │    Config       │                           │                 │
    │  • Camera       │                           │                 │
    │    Config       │                           │                 │
    │  • Output       │                           │                 │
    │    Config       │                           │                 │
    └─────────────────┘                           └─────────────────┘
----

==== Enthaltene Bausteine

[cols="1,2" options="header"]
|===
| Baustein | Verantwortlichkeit

| **routes.py**
| Flask-Routen, Request Parsing, Response Serialization

| **api.py**
| Business Logic, Orchestrierung der Pipeline

| **geometry/**
| Parametrische Puzzle-Generierung, Cut-Algorithmen

| **rendering/**
| Bild-Rendering, Schatten

| **simulation/**
| Kamera-Effekt-Pipeline (11 Effects)

| **calibration/**
| Barrel Distortion Kalibrierung

| **config.py**
| Typsichere Konfiguration


|===

=== Puzzle Solver (Ebene 2)

==== Übersichtsdiagramm

[source]
----
┌─────────────────────────────────────────────────────────────────┐
│                    Puzzle Solver Subsystem                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ┴──────────┐
                                         ▼
                                ┌──────────────────┐
                                │  routes.py       │
                                │                  │
                                │  POST /upload    │
                                │  GET  /extract   │
                                │  GET  /detect-   │
                                │       edges      │
                                │  GET  /solve-    │
                                │       puzzle     │
                                └──────────────────┘
                                        │
       ┌────────────────────────────────┼─────────────────────────┐
       ▼                                ▼                         ▼
┌──────────────┐              ┌──────────────────┐     ┌──────────────────┐
│preprocessing/│              │piece_extraction/ │     │edge_detection/   │
├──────────────┤              ├──────────────────┤     ├──────────────────┤
│              │              │                  │     │                  │
│global_       │              │extractor.py      │     │edge_detector.py  │
│cleaner.py    │─────────────▶│• PieceSegmenter │─────▶│• EdgeDetector    │
│              │              │• PuzzlePiece     │     │• PieceEdge       │
│image_clean.py│              │                  │     │                  │
│              │              │extractor_        │     │edge_detector_    │
│              │              │visualizer.py     │     │visualizer.py     │
│              │              │• PieceVisualizer │     │• EdgeVisualizer  │
│              │              │                  │     │                  │
│              │              │                  │     │                  │
└──────────────┘              └──────────────────┘     └──────────────────┘
                                                                 │
                              ┌──────────────────────────────────┤
                              ▼                                  ▼
                    ┌──────────────────┐              ┌──────────────────┐
                    │edge_matching/    │              │solver/           │
                    ├──────────────────┤              ├──────────────────┤
                    │                  │              │                  │
                    │edge_matcher.py   │──────────────▶│solver.py         │
                    │• EdgeMatcher     │              │• PuzzleSolver    │
                    │• EdgeMatch       │              │• PuzzleSolution  │
                    │                  │              │• PlacedPiece     │
                    │edge_matcher_     │              │                  │
                    │visualizer.py     │              │solver_           │
                    │• MatchVisualizer │              │visualizer.py     │
                    │                  │              │• Solution        │
                    │                  │              │  Visualizer      │
                    └──────────────────┘              └──────────────────┘
----

==== Enthaltene Bausteine

[cols="1,2" options="header"]
|===
| Baustein | Verantwortlichkeit

| **preprocessing/**
| Globale (Kamera) und lokale (Kontur) Korrekturen

| **piece_extraction/**
| Segmentierung, Otsu Verfahren

| **edge_detection/**
| Eck-Erkennung, Kanten-Extraktion und Kanten-Klassifikation

| **edge_matching/**
| Kurvenkorrelation, Tab-Slot-Kompatibilität

| **solver/**
| Corner-Start, Greedy Expansion

| **Visualizers**
| PNG-Outputs für alle Pipeline-Stufen
|===