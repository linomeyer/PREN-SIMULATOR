
ifndef::imagesdir[:imagesdir: ../images]

[[section-building-block-view]]
== Bausteinsicht

Die Bausteinsicht des Systems zeigt auf der ersten Ebene die Hauptkomponenten des Simulators. Die zweite Ebene verfeinert die beiden Subsysteme (Generator und Solver) in ihre internen Bausteine mit deren Verantwortlichkeiten und Abhängigkeiten.

=== Gesamtsystem (Ebene 1)

==== Übersichtsdiagramm

[plantuml, format=svg]
....
@startuml
!define RECTANGLE class

package "PREN Puzzle Simulator" {

  [Flask Application] as Flask

  package "Puzzle Generator Subsystem" {
    [Generator API] as GenAPI
    [Geometry Engine] as Geometry
    [Rendering Engine] as Rendering
    [Camera Simulation] as Camera
    [Calibration] as Calib
  }

  package "Puzzle Solver Subsystem" {
    [Solver API] as SolverAPI
    [Preprocessing] as Preproc
    [Segmentation] as Segment
    [Edge Detection] as EdgeDet
    [Edge Matching] as EdgeMatch
    [Solver Algorithm] as SolverAlgo
  }


  Flask --> GenAPI
  Flask --> SolverAPI

  GenAPI --> Geometry
  GenAPI --> Rendering
  GenAPI --> Camera
  GenAPI --> Calib

  SolverAPI --> Preproc
  SolverAPI --> Segment
  SolverAPI --> EdgeDet
  SolverAPI --> EdgeMatch
  SolverAPI --> SolverAlgo

}

@enduml
....

==== Enthaltene Bausteine

[cols="1,3" options="header"]
|===
| Baustein | Verantwortlichkeit

| **Flask Application**
| REST-API Server; Routing; Request/Response Handling; Session Management

| **Puzzle Generator Subsystem**
| Erzeugt realistische Puzzle-Bilder mit Kamera-Simulation

| **Puzzle Solver Subsystem**
| Analysiert Puzzle-Bilder und rekonstruiert die Lösung

|===

==== Wichtige Schnittstellen

[cols="1,2,2" options="header"]
|===
| Schnittstelle | Protokoll | Beschreibung

| **REST-API**
| HTTP/JSON
| `/generate`, `/solve-puzzle/<filename>`, `/calibrate`

| **File System**
| Local FS
| `app/static/output/` für Visualisierungen, `app/main/img/` für Uploads

| **Configuration**
| Python Dataclasses
| Typsichere Parameter-Objekte (GeneratorConfig, PuzzleConfig, etc.)
|===

<<<

=== Puzzle Generator (Ebene 2)

==== Übersichtsdiagramm

[plantuml, format=svg]
....
@startuml
!define RECTANGLE class

package "Puzzle Generator Subsystem" {

  [routes.py] as Routes
  note right of Routes
    POST /generate
    POST /calibrate
    GET /health
  end note

  [api.py] as API
  note right of API
    generate_puzzle_images()
  end note

  package "geometry/" {
    [puzzle.py] as Puzzle
    note right of Puzzle
      • Generator
      • PuzzlePiece
      • PieceEdge
    end note

    [cuts.py] as Cuts
    note right of Cuts
      • Cut (ABC)
      • 13 Impls
    end note
  }

  package "rendering/" {
    [renderer.py] as Renderer
  }

  package "simulation/" {
    [camera.py] as Camera

    package "effects/" {
      [11 Types] as Effects
    }
  }

  [config.py] as Config
  note left of Config
    • GeneratorConfig
    • PuzzleConfig
    • CameraConfig
    • OutputConfig
  end note

  package "calibration/" {
    [grid_calibrator.py] as GridCalib
  }

  Routes --> API
  API --> Puzzle
  API --> Renderer
  API --> Camera

  Puzzle --> Renderer
  Camera --> Renderer

  Puzzle --> Cuts
  Camera --> Effects
  Puzzle --> Config
  Camera --> GridCalib
}

@enduml
....

==== Enthaltene Bausteine

[cols="1,2" options="header"]
|===
| Baustein | Verantwortlichkeit

| **routes.py**
| Flask-Routen, Request Parsing, Response Serialization

| **api.py**
| Business Logic, Orchestrierung der Pipeline

| **geometry/**
| Parametrische Puzzle-Generierung, Cut-Algorithmen

| **rendering/**
| Bild-Rendering, Schatten

| **simulation/**
| Kamera-Effekt-Pipeline

| **calibration/**
| Barrel Distortion Kalibrierung

| **config.py**
| Typsichere Konfiguration


|===

<<<

=== Puzzle Solver (Ebene 2)

==== Übersichtsdiagramm
[plantuml, format=svg]
....
@startuml
!define RECTANGLE class

package "Puzzle Solver Subsystem" {

  [routes.py] as Routes
  note right of Routes
    POST /upload
    GET /extract
    GET /detect-edges
    GET /solve-puzzle
  end note

  package "preprocessing/" {
    [global_cleaner.py] as GlobalClean
    [image_clean.py] as ImageClean
  }

  package "piece_extraction/" {
    [extractor.py] as Extractor
    note right of Extractor
      • PieceSegmenter
      • PuzzlePiece
    end note

    [extractor_visualizer.py] as ExtractorVis
  }

  package "edge_detection/" {
    [edge_detector.py] as EdgeDetector
    note right of EdgeDetector
      • EdgeDetector
      • PieceEdge
    end note

    [edge_detector_visualizer.py] as EdgeDetectorVis
  }

  package "edge_matching/" {
    [edge_matcher.py] as EdgeMatcher
    note right of EdgeMatcher
      • EdgeMatcher
      • EdgeMatch
    end note

    [edge_matcher_visualizer.py] as MatcherVis
  }

  package "solver/" {
    [solver.py] as Solver
    note right of Solver
      • PuzzleSolver
      • PuzzleSolution
      • PlacedPiece
    end note

    [solver_visualizer.py] as SolverVis
  }

  Routes --> GlobalClean
  GlobalClean --> ImageClean
  ImageClean --> Extractor
  Extractor --> EdgeDetector
  EdgeDetector --> EdgeMatcher
  EdgeMatcher --> Solver

  Extractor --> ExtractorVis
  EdgeDetector --> EdgeDetectorVis
  EdgeDetector --> Solver
  EdgeMatcher --> MatcherVis
  Solver --> SolverVis
}
@enduml
....

==== Enthaltene Bausteine

[cols="1,2" options="header"]
|===
| Baustein | Verantwortlichkeit

| **preprocessing/**
| Globale (Kamera) und lokale (Kontur) Korrekturen

| **piece_extraction/**
| Segmentierung, Otsu Verfahren

| **edge_detection/**
| Eck-Erkennung, Kanten-Extraktion und Kanten-Klassifikation

| **edge_matching/**
| Kurvenkorrelation, Tab-Slot-Kompatibilität

| **solver/**
| Corner-Start, Greedy Expansion

| **Visualizers**
| PNG-Outputs für alle Pipeline-Stufen
|===